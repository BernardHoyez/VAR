<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#059669">
    <meta name="description" content="Verdon Argens Randonn√©e - Club de randonn√©e dans le Var">
    <title>VAR - Verdon Argens Randonn√©e</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon512.png">
    <link rel="apple-touch-icon" href="icon192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .active-menu {
            background-color: #dcfce7 !important;
            color: #15803d !important;
            font-weight: 600;
        }

        .menu-item:hover {
            background-color: #f3f4f6;
        }

        .active-menu:hover {
            background-color: #bbf7d0 !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        const menuItems = [
            { id: 'accueil', label: 'Accueil', icon: 'üè†', file: 'content/accueil.md' },
            { id: 'presentation', label: 'Pr√©sentation', icon: 'üë•', file: 'content/presentation.md' },
            { id: 'randonnees', label: 'Randonn√©es √† venir', icon: 'üìÖ', file: 'randos.md' },
            { id: 'passees', label: 'Randonn√©es pass√©es', icon: '‚õ∞Ô∏è', file: 'content/randos-passees.md' },
            { id: 'galerie', label: 'Galerie photos', icon: 'üì∑', file: 'content/galerie.md' },
            { id: 'infos', label: 'Informations', icon: '‚ÑπÔ∏è', file: 'content/informations.md' }
        ];

        let currentPage = 'accueil';
        let content = '';
        let loading = true;
        let error = '';
        let menuOpen = false;

        function setCurrentPage(pageId) {
            console.log('Changement de page vers:', pageId);
            currentPage = pageId;
            menuOpen = false;
            loadContent();
            render();
        }

        function toggleMenu() {
            menuOpen = !menuOpen;
            render();
        }

        async function loadContent() {
            loading = true;
            error = '';
            render();
            
            const page = menuItems.find(m => m.id === currentPage);
            if (!page) return;

            try {
                const baseUrl = 'https://raw.githubusercontent.com/BernardHoyez/VAR/refs/heads/main/';
                const response = await fetch(baseUrl + page.file);
                
                if (!response.ok) {
                    throw new Error('Fichier non trouv√©');
                }
                
                content = await response.text();
                error = '';
            } catch (err) {
                error = 'Contenu non disponible pour le moment';
                content = '';
            } finally {
                loading = false;
                render();
            }
        }

        function parseMarkdownToHTML(md) {
            if (!md) return '';
            
            let html = md;
            
            // Titres
            html = html.replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold text-gray-800 mt-6 mb-3">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold text-gray-800 mt-8 mb-4">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold text-gray-800 mb-6">$1</h1>');
            
            // Images - URLs relatives
            html = html.replace(/!\[(.*?)\]\(((?!https?:\/\/).*?)\)/gim, function(match, alt, url) {
                const fullUrl = 'https://raw.githubusercontent.com/BernardHoyez/VAR/refs/heads/main/' + url;
                return '<img src="' + fullUrl + '" alt="' + alt + '" class="max-w-full h-auto rounded-lg shadow-md my-4" loading="lazy" />';
            });
            
            // Images - URLs absolues
            html = html.replace(/!\[(.*?)\]\((https?:\/\/.*?)\)/gim, '<img src="$2" alt="$1" class="max-w-full h-auto rounded-lg shadow-md my-4" loading="lazy" />');
            
            // Liens
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2" class="text-green-600 hover:text-green-700 underline">$1</a>');
            
            // Gras
            html = html.replace(/\*\*([^*]+)\*\*/gim, '<strong class="font-bold">$1</strong>');
            
            // Italique
            html = html.replace(/\*([^*]+)\*/gim, '<em class="italic">$1</em>');
            
            // Listes
            html = html.replace(/^\- (.*)$/gim, '<li class="ml-6 mb-2">$1</li>');
            html = html.replace(/(<li.*?<\/li>\n?)+/gim, '<ul class="list-disc my-4 space-y-1">$&</ul>');
            
            // S√©parateurs
            html = html.replace(/^---$/gim, '<hr class="my-6 border-gray-300" />');
            
            // Paragraphes
            const lines = html.split('\n');
            const processed = [];
            let inList = false;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                if (line.trim().startsWith('<ul') || line.trim().startsWith('<li')) {
                    inList = true;
                    processed.push(line);
                } else if (line.trim().startsWith('</ul>')) {
                    inList = false;
                    processed.push(line);
                } else if (line.trim() && !line.startsWith('<') && !inList) {
                    processed.push('<p class="mb-4 text-gray-700 leading-relaxed">' + line + '</p>');
                } else {
                    processed.push(line);
                }
            }
            
            return processed.join('\n');
        }

        function parseMarkdownTable(md) {
            const lines = md.split('\n');
            const rows = [];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim().startsWith('|') && !line.includes('---')) {
                    const cells = line.split('|').map(function(c) { return c.trim(); }).filter(function(c) { return c; });
                    if (cells.length > 0) {
                        rows.push(cells);
                    }
                }
            }
            
            return rows;
        }

        function renderContent() {
            if (loading) {
                return '<div class="flex justify-center items-center py-12"><div class="animate-spin rounded-full h-12 w-12 border-4 border-green-200 border-t-green-600"></div></div>';
            }

            if (error) {
                return '<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-yellow-800"><p class="font-semibold mb-2">' + error + '</p><p class="text-sm">Cette page sera bient√¥t disponible.</p></div>';
            }

            // Tableau pour randonn√©es
            if (currentPage === 'randonnees' && content.includes('|')) {
                const tableRows = parseMarkdownTable(content);
                let tableHTML = '<div><h2 class="text-2xl font-bold text-gray-800 mb-6">Randonn√©es √† venir</h2><div class="bg-white rounded-lg shadow overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><tbody class="bg-white divide-y divide-gray-200">';
                
                for (let i = 0; i < tableRows.length; i++) {
                    const row = tableRows[i];
                    const rowClass = i === 0 ? 'bg-green-50 font-semibold' : 'hover:bg-gray-50';
                    tableHTML += '<tr class="' + rowClass + '">';
                    for (let j = 0; j < row.length; j++) {
                        tableHTML += '<td class="px-4 py-3 text-sm text-gray-900 whitespace-pre-wrap">' + row[j] + '</td>';
                    }
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody></table></div></div>';
                return tableHTML;
            }

            // Contenu standard
            return '<div class="prose prose-green max-w-none">' + parseMarkdownToHTML(content) + '</div>';
        }

        function render() {
            const app = document.getElementById('root');
            
            let menuHTML = '';
            for (let i = 0; i < menuItems.length; i++) {
                const item = menuItems[i];
                const isActive = currentPage === item.id;
                const activeClass = isActive ? 'active-menu' : '';
                menuHTML += '<li><button onclick="setCurrentPage(\'' + item.id + '\')" class="menu-item w-full flex items-center gap-3 px-4 py-3 rounded-lg transition ' + activeClass + '"><span class="text-xl">' + item.icon + '</span><span class="text-sm">' + item.label + '</span></button></li>';
            }

            const mobileMenuDisplay = menuOpen ? 'block' : 'none';
            
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50">
                    <header class="bg-green-600 text-white shadow-lg">
                        <div class="container mx-auto px-4 py-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">‚õ∞Ô∏è</span>
                                    <div>
                                        <h1 class="text-2xl font-bold">VAR</h1>
                                        <p class="text-sm text-green-100">Verdon Argens Randonn√©e</p>
                                    </div>
                                </div>
                                <button onclick="toggleMenu()" class="lg:hidden p-2 hover:bg-green-700 rounded-lg transition">
                                    <span class="text-2xl">${menuOpen ? '‚úï' : '‚ò∞'}</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div class="container mx-auto px-4 py-6 flex gap-6">
                        <nav class="hidden lg:block w-64 bg-white rounded-lg shadow-lg p-4 h-fit sticky top-6">
                            <ul class="space-y-2">${menuHTML}</ul>
                        </nav>

                        <div class="lg:hidden fixed inset-0 z-50 bg-black bg-opacity-50" style="display: ${mobileMenuDisplay}" onclick="toggleMenu()">
                            <nav class="bg-white w-64 h-full p-4 shadow-xl" onclick="event.stopPropagation()">
                                <ul class="space-y-2">${menuHTML}</ul>
                            </nav>
                        </div>

                        <main class="flex-1 bg-white rounded-lg shadow-lg p-6 lg:p-8">
                            ${renderContent()}
                        </main>
                    </div>

                    <footer class="bg-gray-800 text-white py-6 mt-12">
                        <div class="container mx-auto px-4 text-center">
                            <p class="text-sm">¬© 2025 Verdon Argens Randonn√©e - Tous droits r√©serv√©s</p>
                        </div>
                    </footer>
                </div>
            `;
        }

        // Initialisation
        loadContent();

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(reg) { console.log('Service Worker enregistr√©'); })
                    .catch(function(err) { console.log('Erreur SW:', err); });
            });
        }
    </script>
</body>
</html>